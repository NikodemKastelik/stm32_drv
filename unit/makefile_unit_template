#----------------------------------------------------------#
# @brief  Sample makefile for unit test creation.
#
# Remember that any .c file to test has to be included
# directly to access all static members.
#----------------------------------------------------------#

# @brief Unit test name.
PROJNAME = example

# @brief Symbol for mocking out HAL
#
# Set this to 1 if driver should interface with fake HAL.
MOCK_HAL = 0

#----------------------------------------------------------#
# Do not edit anything beneath!
#----------------------------------------------------------#
UNITYDIR = ../unity

SRCDIR   = $(UNITYDIR)
SRCDIR  += .

INCDIR   = ../../hal
INCDIR  += ../../cmsis
INCDIR  += ../../drv/src
INCDIR  += ../../drv/inc
INCDIR  += $(UNITYDIR)

BUILDDIR = build

CC       = gcc

CFLAGS   = -std=c99 -Wall

ifneq ($(MOCK_HAL),0)
INCDIR  += ../mock/inc
SRCDIR  += ../mock/src
CFLAGS  += -D__MOCK_HAL
endif

DEPFLAGS = -MT $@ -MMD -MP -MF $(BUILDDIR)/$*.Td

SRC_C   += $(wildcard $(addsuffix /*.c, $(SRCDIR)))

OBJ      = $(addprefix $(BUILDDIR)/, $(notdir $(SRC_C:.c=.o)))

EXEC     = $(BUILDDIR)/$(PROJNAME)

POSTCC   = @mv -f $(BUILDDIR)/$*.Td $(BUILDDIR)/$*.d && touch $@

$(shell mkdir -p $(BUILDDIR))

vpath %.c $(SRCDIR)

all: TEST

TEST: $(EXEC)
	./$<

$(EXEC): $(OBJ)
	$(CC) $^ -o $@

$(BUILDDIR)/%.o : %.c
$(BUILDDIR)/%.o : %.c $(BUILDDIR)/%.d
	$(CC) $(DEPFLAGS) $(CFLAGS) $(addprefix -I,$(INCDIR)) -c $< -o $@
	$(POSTCC)

.PHONY: clean
clean:
	rm -rf $(BUILDDIR)

$(BUILDDIR)/%.d: ;
.PRECIOUS: $(BUILDDIR)/%.d

include $(wildcard $(patsubst %,$(BUILDDIR)/%.d,$(basename $(SRC_C))))
